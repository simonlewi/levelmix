{{template "base.html" .}}

{{define "title"}}Upload - LevelMix{{end}}

{{define "upload_content"}}
<div class="flex items-center justify-center min-h-screen px-6">
    <div class="text-center max-w-md w-full">
        <!-- This container will hold all states -->
        <div id="main-container" class="state-transition">
            
            <!-- STATE 1: Upload Form (Initial) -->
            <div id="upload-state">
                <h2 class="text-4xl font-bold mb-8">Upload Your Audio</h2>
                
                <form id="upload-form"
                      hx-post="/upload" 
                      hx-encoding="multipart/form-data" 
                      hx-target="#main-container"
                      hx-indicator="#upload-loading">
                      
                    <!-- File Drop Area -->
                    <div id="drop-area" 
                         class="drop-area mb-6 border-2 border-dashed border-gray-600 rounded-lg p-8 cursor-pointer hover:border-cyan-400 transition-colors"
                         onclick="document.getElementById('file-input').click()"
                         role="button"
                         tabindex="0"
                         aria-label="Click to upload file or drag and drop">
                        
                        <div id="drop-content" style="pointer-events: none;">
                            <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="text-gray-400 mb-2">Click to upload or drag and drop</p>
                            <p class="text-gray-500 text-sm">
                                {{if and .IsLoggedIn (or (eq .user.SubscriptionTier 2) (eq .user.SubscriptionTier 3))}}
                                    MP3 and WAV files up to 5GB
                                {{else}}
                                    MP3 files up to 300MB
                                {{end}}
                            </p>
                        </div>
                        
                        <!-- Selected file info (hidden initially) -->
                        <div id="file-info" class="hidden" style="pointer-events: none;">
                            <svg class="w-8 h-8 text-cyan-400 mx-auto mb-2" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                            </svg>
                            <p id="file-name" class="text-cyan-400 font-medium"></p>
                            <p id="file-size" class="text-gray-400 text-sm"></p>
                            <button type="button" 
                                    onclick="removeFile(); event.stopPropagation();"
                                    class="text-red-400 text-sm mt-2 hover:text-red-300 cursor-pointer"
                                    style="pointer-events: auto;">
                                Remove file
                            </button>
                        </div>
                    </div>
                    
                    <input type="file" 
                           id="file-input"
                           name="audio_file" 
                           accept="{{if and .IsLoggedIn (or (eq .user.SubscriptionTier 2) (eq .user.SubscriptionTier 3))}}.mp3,.wav{{else}}.mp3{{end}}" 
                           required
                           class="hidden"
                           onchange="handleFileSelect(this)">
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Target LUFS:</label>
                        <select name="target_lufs" 
                                id="lufs-select"
                                class="block w-full bg-gray-800 border border-gray-600 rounded-lg p-3 text-white">
                            <option value="-14">Streaming (-14 LUFS)</option>
                            <option value="-16">Podcast (-16 LUFS)</option>
                            <option value="-23">Radio (-23 LUFS)</option>
                            <option value="-7" selected>Club Mix (-7 LUFS)</option>
                            <option value="-5">Festival Mix (-5 LUFS)</option>
                            {{if and .IsLoggedIn (or (eq .user.SubscriptionTier 2) (eq .user.SubscriptionTier 3))}}
                            <option value="custom">Custom LUFS 
                                <span class="text-purple-300">({{if eq .user.SubscriptionTier 2}}Premium{{else}}Pro{{end}})</span>
                            </option>
                            {{end}}
                        </select>
                        
                        <!-- Custom LUFS Input (hidden initially) -->
                        {{if and .IsLoggedIn (or (eq .user.SubscriptionTier 2) (eq .user.SubscriptionTier 3))}}
                        <div id="custom-lufs-input" class="hidden mt-4 p-4 bg-gray-700 rounded-lg border border-purple-500/50">
                            <label for="custom_lufs_value" class="block text-sm font-medium text-gray-300 mb-2">
                                Custom LUFS Target
                            </label>
                            <div class="flex items-center space-x-4">
                                <input type="number" 
                                       id="custom_lufs_value" 
                                       name="custom_lufs_value" 
                                       min="-30" 
                                       max="-2" 
                                       step="0.1" 
                                       value="-10"
                                       class="block w-24 px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-purple-400 focus:border-transparent">
                                <span class="text-gray-400 text-sm">Range: -30 to -2 LUFS</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                Lower values = quieter output. Higher values = louder output.
                            </p>
                        </div>
                        {{else if .IsLoggedIn}}
                        <!-- Upgrade prompt for free users -->
                        <div class="mt-4 p-4 bg-gradient-to-r from-purple-900/20 to-cyan-900/20 border border-purple-500/30 rounded-lg">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-purple-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m0-6v2m0-6V9a3 3 0 013-3h0a3 3 0 013 3v0a3 3 0 01-3 3H9a3 3 0 01-3-3V9a3 3 0 013-3h0a3 3 0 013 3z"></path>
                                </svg>
                                <span class="text-purple-300 text-sm font-medium">Custom LUFS targets available with </span>
                                <a href="/pricing" class="text-purple-400 hover:text-purple-300 underline ml-1">Premium</a>
                            </div>
                        </div>
                        {{end}}
                    </div>
                    
                    <button type="submit" 
                            id="upload-btn"
                            disabled
                            class="w-full bg-cyan-400 text-gray-900 px-6 py-3 rounded-lg font-bold hover:bg-cyan-300 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                        Upload & Process
                    </button>
                </form>
                
                <!-- Upload Loading State -->
                <div id="upload-loading" class="htmx-indicator mt-6">
                    <div class="spinner mx-auto mb-4"></div>
                    <p class="text-cyan-400">Uploading your file...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing State Template (will be injected by JavaScript) -->
<template id="processing-template">
    <div id="processing-state" class="state-transition">
        <div class="text-center">
            <div class="spinner mx-auto mb-6"></div>
            <h2 class="text-3xl font-bold mb-4">Processing Your Audio</h2>
            <p id="status-text" class="text-gray-300 mb-8">Initializing...</p>
            
            <div class="bg-gray-800 rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-400">Progress</span>
                    <span id="progress-text" class="text-sm text-cyan-400">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div id="progress-bar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            
            <p class="text-gray-400 text-sm">This usually takes a couple of minutes depending on file size</p>
        </div>
    </div>
</template>

<script>
let selectedFile = null;
let pollInterval = null;

// Progress simulation system
let progressSimulation = {
    currentProgress: 0,
    targetProgress: 0,
    animationId: null,
    lastStatus: '',
    stageStartTime: null,
    estimatedDuration: null
};

// Get user tier from template (rendered server-side)
const userTier = parseInt('{{if and .IsLoggedIn .user}}{{.user.SubscriptionTier}}{{else}}0{{end}}');
const isLoggedIn = '{{.IsLoggedIn}}' === 'true';
const isPremiumUser = isLoggedIn && (userTier === 2 || userTier === 3);

// File selection handler
function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
        selectedFile = file;
        showFileInfo(file);
        document.getElementById('upload-btn').disabled = false;
    }
}

// Show selected file info
function showFileInfo(file) {
    const fileSize = (file.size / (1024 * 1024)).toFixed(2);
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = `${fileSize} MB`;
    
    document.getElementById('drop-content').classList.add('hidden');
    document.getElementById('file-info').classList.remove('hidden');
}

// Remove selected file
function removeFile() {
    selectedFile = null;
    document.getElementById('file-input').value = '';
    document.getElementById('upload-btn').disabled = true;
    
    document.getElementById('drop-content').classList.remove('hidden');
    document.getElementById('file-info').classList.add('hidden');
}

// More realistic progress mapping based on actual processing stages
function getDetailedProgress(status, baseProgress, fileSize, elapsedTime) {
    // Estimate total processing time based on file size (rough approximation)
    const estimatedTotalTime = Math.max(30, Math.min(300, (fileSize || 10000000) / 1000000 * 45)); // 30s to 5min
    
    const progressMaps = {
        'uploaded': { 
            progress: 8, 
            message: 'Upload complete, queuing for processing...',
            duration: 2
        },
        'queued': { 
            progress: 12, 
            message: 'Queued for processing...',
            duration: 5
        },
        'processing': {
            // Break processing into realistic sub-stages
            stages: [
                { progress: 20, message: 'Initializing audio processor...', duration: 8 },
                { progress: 35, message: 'Analyzing audio characteristics...', duration: 15 },
                { progress: 50, message: 'Measuring loudness levels...', duration: 20 },
                { progress: 75, message: 'Normalizing audio to target LUFS...', duration: 40 },
                { progress: 90, message: 'Finalizing processed audio...', duration: 10 },
                { progress: 96, message: 'Uploading normalized file...', duration: 7 }
            ]
        },
        'completed': { 
            progress: 100, 
            message: 'Processing complete!',
            duration: 0
        },
        'failed': { 
            progress: 0, 
            message: 'Processing failed',
            duration: 0
        }
    };
    
    if (status === 'processing') {
        const stages = progressMaps.processing.stages;
        const totalDuration = stages.reduce((sum, stage) => sum + stage.duration, 0);
        const timeProgress = Math.min(elapsedTime / totalDuration, 1);
        
        // Find current stage based on time
        let cumulativeDuration = 0;
        for (let i = 0; i < stages.length; i++) {
            cumulativeDuration += stages[i].duration;
            if (elapsedTime <= cumulativeDuration || i === stages.length - 1) {
                const stageStartProgress = i > 0 ? stages[i-1].progress : 20;
                const stageEndProgress = stages[i].progress;
                const stageTimeProgress = i > 0 ? 
                    (elapsedTime - (cumulativeDuration - stages[i].duration)) / stages[i].duration : 
                    elapsedTime / stages[i].duration;
                
                return {
                    progress: Math.min(stageStartProgress + (stageEndProgress - stageStartProgress) * Math.min(stageTimeProgress, 1), 96),
                    message: stages[i].message
                };
            }
        }
        
        return { progress: 96, message: 'Uploading normalized file...' };
    }
    
    return progressMaps[status] || { progress: baseProgress, message: 'Processing...' };
}

// Enhanced progress animation with smoother transitions
function animateProgress(targetProgress, message) {
    progressSimulation.targetProgress = Math.min(targetProgress, 100);
    
    if (progressSimulation.animationId) {
        cancelAnimationFrame(progressSimulation.animationId);
    }
    
    function updateProgress() {
        const diff = progressSimulation.targetProgress - progressSimulation.currentProgress;
        if (Math.abs(diff) > 0.1) {
            // Slower animation for more realistic feel
            progressSimulation.currentProgress += diff * 0.02;
            
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const statusText = document.getElementById('status-text');
            
            if (progressBar && progressText) {
                const roundedProgress = Math.round(progressSimulation.currentProgress);
                progressBar.style.width = `${progressSimulation.currentProgress}%`;
                progressText.textContent = `${roundedProgress}%`;
            }
            
            if (statusText && message) {
                statusText.textContent = message;
            }
            
            progressSimulation.animationId = requestAnimationFrame(updateProgress);
        } else {
            progressSimulation.currentProgress = progressSimulation.targetProgress;
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar && progressText) {
                progressBar.style.width = `${progressSimulation.currentProgress}%`;
                progressText.textContent = `${Math.round(progressSimulation.currentProgress)}%`;
            }
        }
    }
    
    updateProgress();
}

// Initialize drag and drop when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const dropArea = document.getElementById('drop-area');
    const lufsSelect = document.getElementById('lufs-select');
    const customInput = document.getElementById('custom-lufs-input');
    const uploadForm = document.getElementById('upload-form');
    
    if (dropArea) {
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('drag-over');
        });

        dropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                const fileType = file.type;
                const fileName = file.name.toLowerCase();
                
                // Check file type based on user tier
                let isValidFile = false;
                if (isPremiumUser) {
                    isValidFile = fileType.startsWith('audio/') || fileName.endsWith('.mp3') || fileName.endsWith('.wav');
                } else {
                    isValidFile = fileType.startsWith('audio/mpeg') || fileName.endsWith('.mp3');
                }
                
                if (isValidFile) {
                    const fileInput = document.getElementById('file-input');
                    fileInput.files = files;
                    handleFileSelect(fileInput);
                } else {
                    if (isPremiumUser) {
                        alert('Please upload an MP3 or WAV file');
                    } else {
                        alert('Please upload an MP3 file (WAV support available with Premium)');
                    }
                }
            }
        });
    }
    
    // Handle custom LUFS option toggle
    if (lufsSelect && customInput) {
        lufsSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customInput.classList.remove('hidden');
            } else {
                customInput.classList.add('hidden');
            }
        });
    }
    
    // Handle form submission with custom LUFS validation
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            const lufsSelect = document.getElementById('lufs-select');
            const customValue = document.getElementById('custom_lufs_value');
            
            if (lufsSelect && lufsSelect.value === 'custom' && customValue) {
                const value = parseFloat(customValue.value);
                if (isNaN(value) || value < -30 || value > -2) {
                    e.preventDefault();
                    alert('Please enter a valid LUFS value between -30 and -2');
                    return;
                }
                // Update the select value to the custom value for form submission
                lufsSelect.value = customValue.value;
            }
        });
    }
});

// HTMX event handlers
document.body.addEventListener('htmx:afterRequest', function(evt) {
    console.log('HTMX after request triggered');
    const response = evt.detail.xhr.responseText;
    
    if (response.includes('processing-state') || response.includes('data-file-id')) {
        console.log('Processing state detected, setting up...');
        const template = document.getElementById('processing-template');
        const clone = template.content.cloneNode(true);
        document.getElementById('main-container').innerHTML = '';
        document.getElementById('main-container').appendChild(clone);
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(response, 'text/html');
        const fileId = doc.querySelector('[data-file-id]')?.getAttribute('data-file-id');
        
        console.log('Extracted file ID:', fileId);
        
        if (fileId) {
            progressSimulation.currentProgress = 0;
            progressSimulation.targetProgress = 0;
            animateProgress(5, 'Upload complete, queuing for processing...');
            startStatusPolling(fileId);
        }
    }
});

// Enhanced status polling with better progress calculation
function startStatusPolling(fileId) {
    console.log('Starting enhanced status polling for:', fileId);
    if (pollInterval) clearInterval(pollInterval);
    
    const startTime = Date.now();
    progressSimulation.stageStartTime = startTime;
    let lastStatus = '';
    let fileSize = selectedFile ? selectedFile.size : null;
    
    pollInterval = setInterval(() => {
        const elapsedTime = (Date.now() - startTime) / 1000; // seconds
        
        fetch(`/status/${fileId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Enhanced status response:', data, 'Elapsed time:', elapsedTime);
                
                // Reset stage timer if status changed
                if (data.status !== lastStatus) {
                    progressSimulation.stageStartTime = Date.now();
                    lastStatus = data.status;
                }
                
                const stageElapsedTime = (Date.now() - progressSimulation.stageStartTime) / 1000;
                const progressInfo = getDetailedProgress(data.status, data.progress || 0, fileSize, stageElapsedTime);
                
                animateProgress(progressInfo.progress, progressInfo.message);
                
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    setTimeout(() => showCompletedState(fileId, data), 1000);
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    showErrorState(data.error || 'Processing failed');
                }
            })
            .catch(error => {
                console.error('Status polling error:', error);
                // Don't fail completely on network errors
            });
    }, 1500); // Poll every 1.5 seconds for smoother updates
}

// Show completed state with enhanced download button
function showCompletedState(fileId, data) {
    animateProgress(100, 'Processing complete!');
    
    setTimeout(() => {
        document.getElementById('main-container').innerHTML = `
            <div id="completed-state" class="state-transition">
                <div class="text-center">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-6 checkmark">
                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    
                    <h2 class="text-3xl font-bold mb-4">Processing Complete!</h2>
                    <p class="text-gray-300 mb-8">Your audio has been normalized and is ready for download.</p>
                    
                    <div class="space-y-4">
                        <button onclick="downloadFile('${fileId}')"
                                class="w-full bg-cyan-400 text-gray-900 px-6 py-3 rounded-lg font-bold hover:bg-cyan-300 transition-colors flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Download Processed Audio
                        </button>
                        
                        <button onclick="uploadAnother()"
                                class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-500 transition-colors">
                            Process Another File
                        </button>
                    </div>
                    
                    <!-- Add quality info -->
                    <div class="mt-8 p-4 bg-gray-800 rounded-lg text-sm text-gray-400">
                        <p>✓ Audio normalized to target LUFS</p>
                        <p>✓ High-quality encoding preserved</p>
                        <p>✓ Original file safely stored</p>
                    </div>
                </div>
            </div>
        `;
    }, 1000);
}

// Show error state
function showErrorState(error) {
    document.getElementById('main-container').innerHTML = `
        <div id="error-state" class="state-transition">
            <div class="text-center">
                <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
                
                <h2 class="text-3xl font-bold mb-4 text-red-400">Processing Failed</h2>
                <p class="text-gray-300 mb-8">${error}</p>
                
                <button onclick="uploadAnother()"
                        class="w-full bg-cyan-400 text-gray-900 px-6 py-3 rounded-lg font-bold hover:bg-cyan-300 transition-colors">
                    Try Again
                </button>
            </div>
        </div>
    `;
}

// Enhanced download function for better user experience
function downloadFile(fileId) {
    const button = document.querySelector(`[onclick="downloadFile('${fileId}')"]`);
    
    if (button) {
        // Show loading state
        const originalText = button.innerHTML;
        button.innerHTML = `
            <svg class="animate-spin w-5 h-5 mr-2 inline" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Preparing Download...
        `;
        button.disabled = true;
        
        // Reset button after delay
        setTimeout(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        }, 3000);
    }
    
    // Create download link with better error handling
    const downloadLink = document.createElement('a');
    downloadLink.href = `/download/${fileId}`;
    downloadLink.style.display = 'none';
    
    // Add download attribute to force download
    downloadLink.download = '';
    
    document.body.appendChild(downloadLink);
    
    try {
        downloadLink.click();
    } catch (error) {
        console.error('Download failed:', error);
        
        // Fallback: navigate directly to download URL
        window.location.href = `/download/${fileId}`;
    } finally {
        // Clean up
        setTimeout(() => {
            document.body.removeChild(downloadLink);
        }, 1000);
    }
}

// Upload another file
function uploadAnother() {
    window.location.reload();
}
</script>
{{end}}